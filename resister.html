<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>おえかき登録（スマホ対応）</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { margin: 10px 0; display: block; }
  </style>
</head>
<body>
  <h2>おえかき登録（スマホ対応）</h2>

  <label>絵画像を選択：</label>
  <input type="file" id="drawing" accept="image/*">

  <label>紐づける画像 or 動画：</label>
  <input type="file" id="media" accept="image/*,video/*">

  <button onclick="register()">登録する</button>
  <div id="result"></div>

  <script>
    async function register() {
      const drawingInput = document.getElementById('drawing');
      const mediaInput = document.getElementById('media');
      const result = document.getElementById('result');

      const drawingFile = drawingInput.files[0];
      const mediaFile = mediaInput.files[0];

      if (!drawingFile || !mediaFile) {
        alert("絵画像とメディアを両方選んでください。");
        return;
      }

      try {
        // ハッシュ値を生成（絵画像）
        const drawingBuffer = await drawingFile.arrayBuffer();
        const hashBuffer = await crypto.subtle.digest('SHA-256', drawingBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

        // IndexedDBに保存（Blob形式で保存）
        const dbReq = indexedDB.open("DrawingMediaDB", 1);
        dbReq.onupgradeneeded = function(e) {
          const db = e.target.result;
          db.createObjectStore("pairs");
        };

        dbReq.onsuccess = function(e) {
          const db = e.target.result;
          const tx = db.transaction("pairs", "readwrite");
          const store = tx.objectStore("pairs");
          store.put(mediaFile, hashHex);  // ← Blob形式で保存
          tx.oncomplete = function() {
            result.innerText = "登録完了！この絵をスキャンすれば表示されます。";
          };
        };

        dbReq.onerror = function() {
          alert("保存に失敗しました。");
        };

      } catch (e) {
        alert("エラー：" + e.message);
      }
    }
  </script>
</body>
</html>
