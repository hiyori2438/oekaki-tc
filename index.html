<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>おえかきスキャン</title>
  <style>
    video, canvas { width: 100%; max-width: 300px; margin-top: 10px; }
    #result { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>おえかきをカメラでスキャン</h2>
  <button onclick="startCamera()">カメラを起動</button>
  <video id="camera" autoplay playsinline></video>
  <button onclick="capture()">この画像で照合</button>
  <canvas id="canvas" style="display:none;"></canvas>
  <div id="result">← 撮影して照合！</div>

  <script>
    let video = document.getElementById('camera');
    let canvas = document.getElementById('canvas');
    let context = canvas.getContext('2d');

    function startCamera() {
      navigator.mediaDevices.getUserMedia({
  video: { facingMode: { exact: "environment" } }
})
        .then(stream => video.srcObject = stream)
        .catch(err => alert("カメラの起動に失敗しました: " + err));
    }

    async function capture() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0);

      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
      const arrayBuffer = await blob.arrayBuffer();
      const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

      const dbRequest = indexedDB.open('OekakiDB', 1);
      dbRequest.onsuccess = function(e) {
        const db = e.target.result;
        const tx = db.transaction('drawings', 'readonly');
        const store = tx.objectStore('drawings');
        const getReq = store.get(hashHex);

        getReq.onsuccess = function() {
          const media = getReq.result;
          if (media) {
            if (media.startsWith("data:video")) {
              document.getElementById('result').innerHTML =
                `<video src="${media}" controls autoplay loop style="max-width:100%"></video>`;
            } else {
              document.getElementById('result').innerHTML =
                `<img src="${media}" style="max-width:100%;">`;
            }
          } else {
            document.getElementById('result').innerText = "一致する絵が見つかりませんでした。";
          }
        };
      };
    }
  </script>
</body>
</html>
