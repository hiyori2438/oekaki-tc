<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>おえかきスキャン</title>
  <style>
    video, canvas { width: 100%; max-width: 300px; margin-top: 10px; }
    #result { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>おえかきをカメラでスキャン</h2>
  <button onclick="startCamera()">カメラを起動</button>
  <video id="camera" autoplay playsinline></video>
  <button onclick="capture()">この画像で照合</button>
  <canvas id="canvas" style="display:none;"></canvas>
  <div id="result">← 撮影して照合！</div>

  <script>
    let video = document.getElementById('camera');
    let canvas = document.getElementById('canvas');
    let context = canvas.getContext('2d');

    function startCamera() {
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })  // 外カメラ優先
        .then(stream => video.srcObject = stream)
        .catch(err => alert("カメラの起動に失敗しました: " + err));
    }

    async function capture() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0);

      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
      const arrayBuffer = await blob.arrayBuffer();
      const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

      const dbReq = indexedDB.open("DrawingMediaDB", 1);
      dbReq.onsuccess = function(e) {
        const db = e.target.result;
        const tx = db.transaction("pairs", "readonly");
        const store = tx.objectStore("pairs");
        const getReq = store.get(hashHex);

        getReq.onsuccess = function() {
          const mediaBlob = getReq.result;
          if (!mediaBlob) {
            document.getElementById('result').innerText = "一致する絵が見つかりませんでした。";
            return;
          }

          const url = URL.createObjectURL(mediaBlob);
          const type = mediaBlob.type;

          if (type.startsWith("video/")) {
            document.getElementById('result').innerHTML = `<video src="${url}" controls autoplay loop style="max-width:100%;"></video>`;
          } else if (type.startsWith("image/")) {
            document.getElementById('result').innerHTML = `<img src="${url}" style="max-width:100%;">`;
          } else {
            document.getElementById('result').innerText = "対応していないメディア形式です。";
          }
        };

        getReq.onerror = function() {
          document.getElementById('result').innerText = "データ取得に失敗しました。";
        };
      };

      dbReq.onerror = function() {
        alert("IndexedDBの読み取りに失敗しました。");
      };
    }
  </script>
</body>
</html>

